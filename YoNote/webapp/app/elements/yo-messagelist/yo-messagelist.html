<link rel="import" href="../../../components/polymer/polymer.html">
<link rel="import" href="../../../components/core-ajax/core-ajax.html">
<link rel="import" href="../../../components/core-header-panel/core-header-panel.html">
<link rel="import" href="../../../components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../../components/core-field/core-field.html">
<link rel="import" href="../../../components/core-icon-button/core-icon-button.html">
<link rel="import" href="../../../components/core-scroll-threshold/core-scroll-threshold.html">
<link rel="import" href="../../../components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../../components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../../components/paper-button/paper-button.html">
<link rel="import" href="../../../components/paper-fab/paper-fab.html">
<link rel="import" href="../../../components/paper-input/paper-autogrow-textarea.html">
<link rel="import" href="../../../components/paper-input/paper-input-decorator.html">
<link rel="import" href="../../../components/paper-input/paper-input.html">
<link rel="import" href="../../../components/paper-spinner/paper-spinner.html">

<polymer-element name="yo-messagelist" attributes="group userId">
  <template>
    <link rel="stylesheet" href="yo-messagelist.css">

    <div layout vertical fit hero-id="group-{{group._id}}" hero>
        <div style="position: relative; height: 100%;" fit>
          <core-scroll-threshold id="threshold" scrollTarget="{{$.headerPanel.scroller}}" lowerThreshold="50" on-lower-trigger="{{loadMore}}" fit></core-scroll-threshold>
          <core-header-panel id="headerPanel" fit fixed>
            <core-toolbar mode="standard">
              <core-icon-button icon="arrow-back" on-tap="{{onback}}"></core-icon-button>
              <div flex></div>
              <paper-input label="笔记查询" value="{{searchText}}" style="font-size: 16px;" hidden?="{{!searchMode}}"></paper-input>
              <core-icon-button icon="close" on-tap="{{exitSearchMode}}" title="关闭查询模式" hidden?="{{!searchMode}}"></core-icon-button>
              <core-icon-button icon="search" on-tap="{{enterSearchMode}}" title="进入查询模式" hidden?="{{searchMode}}"></core-icon-button>
              <div class="bottom indent">{{group.name}}</div>
            </core-toolbar>

            <div id="scroller" layout vertical>
              <template repeat="{{msg in messages}}">
                <div class="messageContainer" layout horizontal>
                  <div class="middle avatar" style="background-image: url({{msg.header}})"></div>
                  <paper-shadow class="card" z="1" layout vertical cross-fade flex on-tap="{{onMessageClicked}}">
                      <div layout horizontal center class="title">
                        <template repeat="{{tag in msg.tags}}">
                          <paper-button class="tag-button">{{tag}}</paper-button>
                        </template>
                        <div flex></div>
                        <div class="date">{{msg.date}}</div>
                      </div>
                      <div layout vertical flex class="content">
                        <pre style="margin: 1em 1em;">{{msg.content}}</pre>
                      </div>
                  </paper-shadow>
                </div>
              </template>
              <paper-spinner active?="{{loading}}" style="margin: 20px;" self-center></paper-spinner>
            </div>
          </core-header-panel>
          <paper-spinner active?="{{refreshing}}" style="position: absolute; right: 20px; bottom: 20px;"></paper-spinner>
        </div>

        <footer>
          <div id="editorFooter" layout horizontal center>
            <paper-input-decorator id="messageEditor" label="笔记内容" floatingLabel flex>
              <paper-autogrow-textarea maxRows="10">
                <textarea value="{{newMessage}}"></textarea>
              </paper-autogrow-textarea>
            </paper-input-decorator>
            <paper-fab icon="arrow-forward" class="blue" title="arrow-forward"
                on-tap="{{sendMessage}}" disabled?="{{!newMessage}}"></paper-fab>
          </div>
        </footer>
    </div>

    <core-ajax id="ajax" handleAs="json" contentType="application/json"></core-ajax>
  </template>
  <script>
    (function () {
      var makeRequest = function (scope, callback, url, method, params, body) {
        var responseCallback = function (event) {
          scope.$.ajax.removeEventListener('core-response', responseCallback);
          scope.$.ajax.removeEventListener('core-error', errorCallback);

          if (event.detail.response.success) {
            callback(scope, event.detail.response.data);
          } else {
            scope.fire('user-error', event.detail.response.toString());
            callback(scope);
          }
        };
        var errorCallback = function (event) {
          scope.$.ajax.removeEventListener('core-response', responseCallback);
          scope.$.ajax.removeEventListener('core-error', errorCallback);

          scope.fire('user-error', event.detail.response.toString());
          callback(scope);
        };

        scope.$.ajax.url = url;
        scope.$.ajax.method = method;
        scope.$.ajax.params = params;
        scope.$.ajax.body = body ? JSON.stringify(body) : undefined;
        scope.$.ajax.addEventListener('core-response', responseCallback);
        scope.$.ajax.addEventListener('core-error', errorCallback);
        scope.$.ajax.go();
      };

      var testLog = function (element) {
        console.log(element.scrollTop);
        if (element.parentElement) {
          testLog(element.parentElement);
        }
      };

      Polymer({
        ready: function () {
          this.loading = false;
          this.refreshing = false;
          this.allLoaded = false;
          this.searchMode = false;
        },
        onback: function (event, detail, sender) {
          this.fire('back');
        },
        groupChanged: function (oldValue, newValue) {
          this.messages = [];
          if (newValue) {
            this.loading = true;
            makeRequest(this, function (scope, messages) {
              scope.messages = messages.concat(scope.messages);
              scope.loading = false;
            }, '/api/group/' + this.group.id + '/message', 'GET', {
              userid: this.userId,
              last: this.messages.length > 0 ? this.messages[0].timestamp : undefined
            });
          }
        },
        sendMessage: function (event, detail, sender) {
          this.refreshing = true;
          makeRequest(this, function (scope, messages) {
            scope.refreshing = false;
            if (messages) {
              scope.messages = messages.concat(scope.messages);
            }
            scope.$.headerPanel.scroller.scrollTop = 0;
          }, '/api/group/' + this.group.id + '/message', 'POST', undefined, {
            userid: this.userId,
            content: this.newMessage
          });

          this.newMessage = '';
        },
        onMessageClicked: function (event, detail, sender) {
          testLog(sender);
          return;
        },
        loadMore: function (event, detail, sender) {
          if (this.allLoaded) return;

          this.loading = true;
          makeRequest(this, function (scope, messages) {
            if (messages) {
              if (messages.length > 0) {
                messages.forEach(function (item) {
                  scope.messages.push(item);
                });
              } else {
                scope.allLoaded = true;
                scope.fire('user-error', '已加载全部历史记录');
              }
            }
            scope.loading = false;
            scope.$.threshold.clearLower();
          }, '/api/group/' + this.group.id + '/message', 'GET', {
            userid: this.userId,
            last: this.messages.length > 0 ? this.messages[this.messages.length - 1].timestamp : undefined
          });
        },
        searchTextChanged: function (oldValue, newValue) {
          if (newValue && oldValue != newValue) {
            this.loading = true;
            if (this.searchHandler) {
              this.cancelAsync(this.searchHandler);
              this.searchHandler = undefined;
            }

            this.searchHandler = this.async(function() {
              var encoded = encodeURIComponent(newValue);
              makeRequest(this, function (scope, messages) {
                if (messages) {
                  scope.messages = messages;
                }
                scope.loading = false;
              }, '/api/group/' + this.group.id + '/message/contentsearch', 'GET', {
                userid: this.userId,
                q: encoded
              });
            }, null, 1000);
          }
        },
        enterSearchMode: function (event, detail, sender) {
          this.restoreMessage = this.messages;
          this.messages = [];
          this.searchMode = true;
        },
        exitSearchMode: function (event, detail, sender) {
          this.messages = this.restoreMessage;
          this.restoreMessage = undefined;
          this.searchMode = false;
        }
      });
    })();
  </script>
</polymer-element>
