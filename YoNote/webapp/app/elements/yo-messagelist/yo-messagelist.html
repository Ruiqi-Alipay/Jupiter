<link rel="import" href="../../../components/polymer/polymer.html">
<link rel="import" href="../../../components/core-ajax/core-ajax.html">
<link rel="import" href="../../../components/core-header-panel/core-header-panel.html">
<link rel="import" href="../../../components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../../components/core-field/core-field.html">
<link rel="import" href="../../../components/core-animation/core-animation.html">
<link rel="import" href="../../../components/core-icon-button/core-icon-button.html">
<link rel="import" href="../../../components/core-scroll-threshold/core-scroll-threshold.html">
<link rel="import" href="../../../components/paper-fab/paper-fab.html">
<link rel="import" href="../../../components/paper-input/paper-autogrow-textarea.html">
<link rel="import" href="../../../components/paper-input/paper-input-decorator.html">
<link rel="import" href="../../../components/paper-input/paper-input.html">
<link rel="import" href="../../../components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../../components/paper-item/paper-item.html">
<link rel="import" href="../../../components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="../../../components/paper-shadow/paper-shadow.html">
<link rel="import" href="../yo-groupdialog/yo-groupdialog.html">
<link rel="import" href="yo-messageItem.html">
<link rel="import" href="../yo-http/yo-http.html">

<polymer-element name="yo-messagelist" attributes="group userId selectedTags">
  <template>
    <link rel="stylesheet" href="yo-messagelist.css">

    <div layout vertical style="position: relative; height: 100%;" fit hero-id="group-{{group.id}}" hero>
      <core-scroll-threshold id="threshold" scrollTarget="{{$.headerPanel.scroller}}" lowerThreshold="25" on-lower-trigger="{{loadMore}}" fit></core-scroll-threshold>
      <core-header-panel id="headerPanel" fit fixed>
        <core-toolbar mode="standard">
          <core-icon-button icon="arrow-back" on-tap="{{onback}}"></core-icon-button>
          <div flex></div>
          <paper-input label="笔记查询" value="{{searchText}}" style="font-size: 16px;" hidden?="{{!searchMode}}"></paper-input>
          <core-icon-button icon="close" on-tap="{{exitSearchMode}}" title="关闭查询模式" hidden?="{{!searchMode}}"></core-icon-button>
          <core-icon-button icon="search" on-tap="{{enterSearchMode}}" title="进入查询模式" hidden?="{{searchMode}}"></core-icon-button>
          <core-icon-button icon="more-vert" on-tap="{{menuClicked}}">
            <paper-dropdown id="groupMenu" class="no-padding" halign="right">
              <div class="menu">
                <paper-item on-click="{{showEditDialog}}"><core-icon icon="input"></core-icon>编辑群组</paper-item>
                <paper-item on-click="{{showConfirmDialog}}"><core-icon icon="close"></core-icon>删除群组</paper-item>
              </div>
            </paper-dropdown>
          </core-icon-button>
        </core-toolbar>

        <div id="scroller" layout vertical>
          <template repeat="{{msg, index in messages}}">
            <div class="messageContainer" layout horizontal>
              <div layout vertical center style="margin-right: 15px;">
                <div class="middle avatar" style="background-image: url({{msg.senderHeader}})"></div>
                <div class="tag-button">{{msg.senderName}}</div>
              </div>
              <paper-shadow z="1" flex>
                <yo-messageItem message="{{msg}}" userId="{{userId}}" itemIndex="{{index}}" selectIndex="{{selectIndex}}"></yo-messageItem>
              </paper-shadow>
            </div>
          </template>
          <paper-spinner active?="{{loading}}" style="margin: 20px;" self-center></paper-spinner>
        </div>
      </core-header-panel>
      <paper-fab id="sendButton" icon="create" class="blue" title="确认"
            on-tap="{{openEditor}}"></paper-fab>
    </div>

    <yo-groupdialog id="editDialog" subject="{{dialogSubject}}" on-action-confirm="{{onActionConfirm}}"></yo-groupdialog>

    <yo-http id="yoHttp"></yo-http>
  </template>
  <script>
    (function () {
      var scrollToTop = function (targetElement) {
        var animation = new CoreAnimation();
        animation.duration = 300;
        animation.target = targetElement;
        animation.fill = 'forwards';
        var total = targetElement.scrollTop;
        animation.customEffect = function(timeFraction, target, animation) {
          target.scrollTop = (1 - timeFraction) * total;
        };
        animation.play();
      };

      var encodeQueyTags = function (selectedTags) {
        if (!selectedTags) return;

        var tags = [];
        selectedTags.forEach(function (item) {
          if (item.select) {
            tags.push(item.name);
          }
        });

        if (tags.length > 0) return encodeURIComponent(tags.join(','));
      };

      var refreshMessage = function (scope) {
        scope.loading = true;
        scope.$.yoHttp.makeRequest(scope, function (scope, messages) {
          scope.messages = messages;
          scope.loading = false;
        }, '/note/api/group/' + scope.group.id + '/message', 'GET', {
          userid: scope.userId,
          last: scope.messages.length > 0 ? scope.messages[0].timestamp : undefined,
          tags: encodeQueyTags(scope.selectedTags)
        });
      };

      var getMsgTags = function (scope) {
        var newMsgTags = [];
        if (scope.selectedTags) {
          scope.selectedTags.forEach(function (item) {
            newMsgTags.push({
              name: item.name,
              select: false
            })
          });
        }
        return newMsgTags;
      };

      Polymer({
        ready: function () {
          this.selectIndex = -1;
          this.loading = false;
          this.allLoaded = false;
          this.searchMode = false;
        },
        onback: function (event, detail, sender) {
          this.fire('back');
        },
        groupChanged: function (oldValue, newValue) {
          if (!oldValue || oldValue.id != newValue.id) {
            this.messages = [];
            refreshMessage(this);
          }
        },
        openEditor: function (event, detail, sender) {
          var editorContainer = document.getElementById('editor-container');
          editorContainer.showEditor(getMsgTags(this), this.group.id, this.userId);
        },
        onSendFinished: function (messages, updatedGroup) {
          if (messages) {
            messages.reverse();
            for (var index in messages) {
              this.messages.unshift(messages[index]);
            }

            if (!this.group.recents) {
              this.group.recents = [];
            }

            if (messages.length == 1) {
              this.group.recents.unshift(messages[0]);
            } else if (messages.length >= 2) {
              this.group.recents.unshift(messages[1]);
              this.group.recents.unshift(messages[0]);
            }

            if (this.group.recents.length > 2) {
              this.group.recents.splice(2);
            }
          }
          scrollToTop(this.$.headerPanel.scroller);

          if (updatedGroup) {
            updatedGroup.members = this.group.members;
            this.group = updatedGroup;
          }

          this.newMsgTags = [];
          if (updatedGroup.msgTags) {
            for (var index in updatedGroup.msgTags) {
              this.newMsgTags.push({
                name: updatedGroup.msgTags[index],
                select: false
              })
            }
          }
        },
        loadMore: function (event, detail, sender) {
          if (this.allLoaded) return;

          this.loading = true;
          this.async(function () {
            this.$.yoHttp.makeRequest(this, function (scope, messages) {
              if (messages) {
                if (messages.length > 0) {
                  messages.forEach(function (item) {
                    scope.messages.push(item);
                  });
                } else {
                  scope.allLoaded = true;
                  scope.fire('user-error', '已加载全部历史记录');
                }
              }
              scope.loading = false;
              scope.$.threshold.clearLower();
            }, '/note/api/group/' + this.group.id + '/message', 'GET', {
              userid: this.userId,
              tags: encodeQueyTags(this.selectedTags),
              last: this.messages.length > 0 ? this.messages[this.messages.length - 1].timestamp : undefined
            });
          }, null, 1000);
        },
        searchTextChanged: function (oldValue, newValue) {
          if (newValue && oldValue != newValue) {
            this.loading = true;
            if (this.searchHandler) {
              this.cancelAsync(this.searchHandler);
              this.searchHandler = undefined;
            }

            this.searchHandler = this.async(function() {
              var encoded = encodeURIComponent(newValue);
              this.$.yoHttp.makeRequest(this, function (scope, messages) {
                if (messages) {
                  scope.messages = messages;
                }
                scope.loading = false;
              }, '/note/api/group/' + this.group.id + '/message/contentsearch', 'GET', {
                userid: this.userId,
                q: encoded
              });
            }, null, 1000);
          }
        },
        enterSearchMode: function (event, detail, sender) {
          this.restoreMessage = this.messages;
          this.messages = [];
          this.searchMode = true;
        },
        exitSearchMode: function (event, detail, sender) {
          this.messages = this.restoreMessage;
          this.restoreMessage = undefined;
          this.searchMode = false;
        },
        menuClicked: function (event, detail, sender) {
          this.$.groupMenu.toggle();
        },
        showEditDialog: function (event, detail, sender) {
          this.dialogSubject = '编辑群组';
          this.$.editDialog.showDialog(true, this.group.name);
        },
        showConfirmDialog: function (event, detail, sender) {
          this.dialogSubject = '确定删除群组 "' + this.group.name + '" ?';
          this.$.editDialog.showDialog(false);
        },
        onActionConfirm: function (event, detail, sender) {
          if (detail.editor) {
            this.$.yoHttp.makeRequest(this, function (scope, group) {
              if (group) {
                scope.fire('group-updated', group);
              }
              scope.$.editDialog.closeDialog();
            }, '/note/api/group/' + this.group.id, 'POST', undefined, {
              userid: this.userId,
              name: detail.name
            }, 'application/json');
          } else {
            this.$.yoHttp.makeRequest(this, function (scope, group) {
              if (group) {
                scope.fire('group-deleted', group);
              }
              scope.$.editDialog.closeDialog();
            }, '/note/api/group/' + this.group.id, 'DELETE', {
              userid: this.userId
            });
          }
        },
        refreshList: function () {
          this.messages = [];
          refreshMessage(this);
        }
      });
    })();
  </script>
</polymer-element>
