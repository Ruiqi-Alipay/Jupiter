<link rel="import" href="../../../components/polymer/polymer.html">
<link rel="import" href="../../../components/core-ajax/core-ajax.html">
<link rel="import" href="../../../components/core-header-panel/core-header-panel.html">
<link rel="import" href="../../../components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../../components/core-field/core-field.html">
<link rel="import" href="../../../components/core-animation/core-animation.html">
<link rel="import" href="../../../components/core-icon-button/core-icon-button.html">
<link rel="import" href="../../../components/core-scroll-threshold/core-scroll-threshold.html">
<link rel="import" href="../../../components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../../components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../../components/paper-button/paper-button.html">
<link rel="import" href="../../../components/paper-fab/paper-fab.html">
<link rel="import" href="../../../components/paper-input/paper-autogrow-textarea.html">
<link rel="import" href="../../../components/paper-input/paper-input-decorator.html">
<link rel="import" href="../../../components/paper-input/paper-input.html">
<link rel="import" href="../../../components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../../components/paper-item/paper-item.html">
<link rel="import" href="../../../components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="../yo-groupdialog/yo-groupdialog.html">

<polymer-element name="yo-messagelist" attributes="group userId selectedTags">
  <template>
    <link rel="stylesheet" href="yo-messagelist.css">

    <div layout vertical style="position: relative; height: 100%;" fit hero-id="group-{{group._id}}" hero>
      <core-scroll-threshold id="threshold" scrollTarget="{{$.headerPanel.scroller}}" lowerThreshold="25" on-lower-trigger="{{loadMore}}" fit></core-scroll-threshold>
      <core-header-panel id="headerPanel" fit fixed>
        <core-toolbar mode="standard">
          <core-icon-button icon="arrow-back" on-tap="{{onback}}"></core-icon-button>
          <div flex></div>
          <paper-input label="笔记查询" value="{{searchText}}" style="font-size: 16px;" hidden?="{{!searchMode}}"></paper-input>
          <core-icon-button icon="close" on-tap="{{exitSearchMode}}" title="关闭查询模式" hidden?="{{!searchMode}}"></core-icon-button>
          <core-icon-button icon="search" on-tap="{{enterSearchMode}}" title="进入查询模式" hidden?="{{searchMode}}"></core-icon-button>
          <core-icon-button icon="more-vert" on-tap="{{menuClicked}}">
            <paper-dropdown id="groupMenu" class="no-padding" halign="right">
              <div class="menu">
                <paper-item on-click="{{showEditDialog}}"><core-icon icon="input"></core-icon>编辑群组</paper-item>
                <paper-item on-click="{{showConfirmDialog}}"><core-icon icon="close"></core-icon>删除群组</paper-item>
              </div>
            </paper-dropdown>
          </core-icon-button>
        </core-toolbar>

        <div id="scroller" layout vertical>
          <template repeat="{{msg in messages}}">
            <div class="messageContainer" layout horizontal>
              <div class="middle avatar" style="background-image: url({{msg.header}})"></div>
              <paper-shadow class="card" z="1" layout vertical cross-fade flex on-tap="{{onMessageClicked}}">
                  <div layout horizontal center class="title">
                    <template repeat="{{tag in msg.tags}}">
                      <paper-button class="tag-button">{{tag}}</paper-button>
                    </template>
                    <div flex></div>
                    <div class="date">{{msg.date}}</div>
                  </div>
                  <div layout vertical flex class="content">
                    <pre style="margin: 1em 1em;">{{msg.content}}</pre>
                  </div>
              </paper-shadow>
            </div>
          </template>
          <paper-spinner active?="{{loading}}" style="margin: 20px;" self-center></paper-spinner>
        </div>
      </core-header-panel>
      <paper-spinner active?="{{refreshing}}" style="position: absolute; right: 20px; bottom: 20px;"></paper-spinner>

      <div id="editorFooter" layout horizontal>
        <div layout vertical flex>
          <div layout horizontal wrap center>
            <template repeat="{{tag in newMsgTags}}">
              <paper-button toggle active class="tagToggle">{{tag}}</paper-button>
            </template>
            <paper-input-decorator label="添加标签">
              <input is="core-input" value="{{newTag}}">
            </paper-input-decorator>
            <core-icon-button icon="add" disabled?="{{!newTag}}" on-click="{{createNewTag}}"></core-icon-button>
          </div>
          <paper-input-decorator id="messageEditor" label="笔记内容" floatingLabel>
            <paper-autogrow-textarea maxRows="10">
              <textarea value="{{newMessage}}"></textarea>
            </paper-autogrow-textarea>
          </paper-input-decorator>
        </div>
        
        <paper-fab id="sendButton" icon="create" class="blue" title="确认"
              on-tap="{{sendMessage}}" disabled?="{{!newMessage}}"></paper-fab>
      </div>
    </div>

    <yo-groupdialog id="editDialog" subject="{{dialogSubject}}" on-action-confirm="{{onActionConfirm}}"></yo-groupdialog>

    <core-ajax id="ajax" handleAs="json"></core-ajax>
  </template>
  <script>
    (function () {
      var makeRequest = function (scope, callback, url, method, params, body, contentType) {
        var responseCallback = function (event) {
          scope.$.ajax.removeEventListener('core-response', responseCallback);
          scope.$.ajax.removeEventListener('core-error', errorCallback);

          if (event.detail.response.success) {
            callback(scope, event.detail.response.data, event.detail.response.ext);
          } else {
            scope.fire('user-error', event.detail.response.toString());
            callback(scope);
          }
        };
        var errorCallback = function (event) {
          scope.$.ajax.removeEventListener('core-response', responseCallback);
          scope.$.ajax.removeEventListener('core-error', errorCallback);

          scope.fire('user-error', event.detail.response.toString());
          callback(scope);
        };

        scope.$.ajax.url = url;
        if (contentType) {
          scope.$.ajax.contentType = contentType;
        } else {
          scope.$.ajax.contentType = 'application/x-www-form-urlencoded';
        }
        
        scope.$.ajax.method = method;
        scope.$.ajax.params = params;
        scope.$.ajax.body = body ? JSON.stringify(body) : undefined;
        scope.$.ajax.addEventListener('core-response', responseCallback);
        scope.$.ajax.addEventListener('core-error', errorCallback);
        scope.$.ajax.go();
      };

      var scrollToTop = function (targetElement) {
        var animation = new CoreAnimation();
        animation.duration = 300;
        animation.target = targetElement;
        animation.fill = 'forwards';
        var total = targetElement.scrollTop;
        animation.customEffect = function(timeFraction, target, animation) {
          target.scrollTop = (1 - timeFraction) * total;
        };
        animation.play();
      };

      var encodeQueyTags = function (selectedTags) {
        if (!selectedTags) return;

        var tags = [];
        selectedTags.forEach(function (item) {
          if (item.select) {
            tags.push(item.name);
          }
        });

        if (tags.length > 0) return encodeURIComponent(tags.join(','));
      };

      var refreshMessage = function (scope) {
          scope.loading = true;
          makeRequest(scope, function (scope, messages) {
            scope.messages = messages;
            scope.loading = false;
          }, '/note/api/group/' + scope.group._id + '/message', 'GET', {
            userid: scope.userId,
            last: scope.messages.length > 0 ? scope.messages[0].timestamp : undefined,
            tags: encodeQueyTags(scope.selectedTags)
          });
      };

      Polymer({
        ready: function () {
          this.loading = false;
          this.refreshing = false;
          this.allLoaded = false;
          this.searchMode = false;
          this.newMsgTags = [];
        },
        onback: function (event, detail, sender) {
          this.fire('back');
        },
        groupChanged: function (oldValue, newValue) {
          if (!oldValue || oldValue._id != newValue._id) {
            this.messages = [];
            refreshMessage(this);
          }
        },
        sendMessage: function (event, detail, sender) {
          this.refreshing = true;
          makeRequest(this, function (scope, messages, newGroup) {
            scope.refreshing = false;
            if (messages) {
              messages.reverse();
              messages.forEach(function (item) {
                scope.messages.unshift(item);
              });
            }
            scrollToTop(scope.$.headerPanel.scroller);

            if (newGroup) {
              scope.group = newGroup;
            }
          }, '/note/api/group/' + this.group._id + '/message', 'POST', undefined, {
            userid: this.userId,
            content: this.newMessage,
            tags: this.newMsgTags
          }, 'application/json');

          this.newMessage = '';
        },
        onMessageClicked: function (event, detail, sender) {
          testLog(sender);
          return;
        },
        loadMore: function (event, detail, sender) {
          if (this.allLoaded) return;

          this.loading = true;
          this.async(function () {
            makeRequest(this, function (scope, messages) {
              if (messages) {
                if (messages.length > 0) {
                  messages.forEach(function (item) {
                    scope.messages.push(item);
                  });
                } else {
                  scope.allLoaded = true;
                  scope.fire('user-error', '已加载全部历史记录');
                }
              }
              scope.loading = false;
              scope.$.threshold.clearLower();
            }, '/note/api/group/' + this.group._id + '/message', 'GET', {
              userid: this.userId,
              tags: encodeQueyTags(this.selectedTags),
              last: this.messages.length > 0 ? this.messages[this.messages.length - 1].timestamp : undefined
            });
          }, null, 1000);
        },
        searchTextChanged: function (oldValue, newValue) {
          if (newValue && oldValue != newValue) {
            this.loading = true;
            if (this.searchHandler) {
              this.cancelAsync(this.searchHandler);
              this.searchHandler = undefined;
            }

            this.searchHandler = this.async(function() {
              var encoded = encodeURIComponent(newValue);
              makeRequest(this, function (scope, messages) {
                if (messages) {
                  scope.messages = messages;
                }
                scope.loading = false;
              }, '/note/api/group/' + this.group._id + '/message/contentsearch', 'GET', {
                userid: this.userId,
                q: encoded
              });
            }, null, 1000);
          }
        },
        enterSearchMode: function (event, detail, sender) {
          this.restoreMessage = this.messages;
          this.messages = [];
          this.searchMode = true;
        },
        exitSearchMode: function (event, detail, sender) {
          this.messages = this.restoreMessage;
          this.restoreMessage = undefined;
          this.searchMode = false;
        },
        menuClicked: function (event, detail, sender) {
          this.$.groupMenu.toggle();
        },
        showEditDialog: function (event, detail, sender) {
          this.dialogSubject = '编辑群组';
          this.$.editDialog.showDialog(true, this.group.name);
        },
        showConfirmDialog: function (event, detail, sender) {
          this.dialogSubject = '确定删除群组 "' + this.group.name + '" ?';
          this.$.editDialog.showDialog(false);
        },
        onActionConfirm: function (event, detail, sender) {
          if (detail.editor) {
            makeRequest(this, function (scope, group) {
              if (group) {
                scope.fire('group-updated', group);
              }
              scope.$.editDialog.closeDialog();
            }, '/note/api/group/' + this.group._id, 'POST', undefined, {
              userid: this.userId,
              name: detail.name
            }, 'application/json');
          } else {
            makeRequest(this, function (scope, group) {
              if (group) {
                scope.fire('group-deleted', group);
              }
              scope.$.editDialog.closeDialog();
            }, '/note/api/group/' + this.group._id, 'DELETE', {
              userid: this.userId
            });
          }
        },
        createNewTag: function (event, detail, sender) {
          this.newMsgTags.push(this.newTag);
          this.newTag = '';
        },
        refreshList: function () {
          this.messages = [];
          refreshMessage(this);
        }
      });
    })();
  </script>
</polymer-element>
