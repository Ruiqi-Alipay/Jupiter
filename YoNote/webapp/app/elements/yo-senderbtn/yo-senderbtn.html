<link rel="import" href="../../../components/polymer/polymer.html">
<link rel="import" href="../../../components/core-ajax/core-ajax.html">
<link rel="import" href="../../../components/paper-fab/paper-fab.html">
<link rel="import" href="../../../components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../../components/paper-toast/paper-toast.html">

<polymer-element name="yo-senderbtn">
	<template layout horizontal end>
		<link rel="stylesheet" href="yo-senderbtn.css">
		<paper-spinner active?="{{sending}}"></paper-spinner>
		<paper-fab icon="send" class="editFab green" title="发送" on-click="{{sendMessage}}" hidden?="{{sending}}"></paper-fab>
		<core-ajax id="ajax" handleAs="json"></core-ajax>
		<paper-toast id="toast" class="capsule" text="日志内容不可为空" style="padding-right: 60px;"></paper-toast>
	</template>
	<script>
	(function () {
      var makeRequest = function (scope, callback, url, method, params, body, contentType) {
        var responseCallback = function (event) {
          scope.$.ajax.removeEventListener('core-response', responseCallback);
          scope.$.ajax.removeEventListener('core-error', errorCallback);

          if (event.detail.response.success) {
            callback(scope, event.detail.response.data, event.detail.response.ext);
          } else {
            scope.fire('user-error', event.detail.response.toString());
            callback(scope);
          }
        };
        var errorCallback = function (event) {
          scope.$.ajax.removeEventListener('core-response', responseCallback);
          scope.$.ajax.removeEventListener('core-error', errorCallback);

          scope.fire('user-error', event.detail.response.toString());
          callback(scope);
        };

        scope.$.ajax.url = url;
        if (contentType) {
          scope.$.ajax.contentType = contentType;
        } else {
          scope.$.ajax.contentType = 'application/x-www-form-urlencoded';
        }
        
        scope.$.ajax.method = method;
        scope.$.ajax.params = params;
        scope.$.ajax.body = body ? JSON.stringify(body) : undefined;
        scope.$.ajax.addEventListener('core-response', responseCallback);
        scope.$.ajax.addEventListener('core-error', errorCallback);
        scope.$.ajax.go();
      };

		Polymer({
			ready: function () {
				this.sending = false;
			},
			sendMessage: function () {
				this.sending = true;
				var tagbar = document.getElementById('yo-tagbar');
				var useTags = [];
				if (tagbar.newMsgTags) {
					tagbar.newMsgTags.forEach(function (item) {
						if (item.select) useTags.push(item.name);
					});
				}

				var html = quill.getHTML();
				var text = quill.getText();

				if (text.replace(/ /g,'').length < 2) {
					this.sending = false;
					this.$.toast.show();
					return;
				}

				makeRequest(this, function (scope, messages, updatedGroup) {
					scope.sending = false;
					toggleEditor(document.getElementById('editor-container'), false);
					document.getElementById('yo-app').onSendFinished(messages, updatedGroup);
				}, '/note/api/group/' + tagbar.groupId + '/message', 'POST', undefined, {
					userid: tagbar.userId,
					text: text,
					html: html,
					tags: useTags
				}, 'application/json');
			}
		});
	})();
	</script>
</polymer-element>












