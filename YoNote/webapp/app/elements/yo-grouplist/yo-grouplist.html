<link rel="import" href="../../../components/polymer/polymer.html">
<link rel="import" href="../../../components/core-icon/core-icon.html">
<link rel="import" href="../../../components/core-ajax/core-ajax.html">
<link rel="import" href="../../../components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../../components/paper-ripple/paper-ripple.html">
<link rel="import" href="../yo-groupdialog/yo-groupdialog.html">

<polymer-element name="yo-grouplist" attributes="groups userId">
	<template>
		<link rel="stylesheet" href="yo-grouplist.css">

		<div id="groupParent" horizontal wrap layout fit>
		    <paper-shadow class="card addCard" z="1" on-tap="{{showGroupDialog}}">
			    <div vertical layout center center-justified fit>
			    	<core-icon class="addCardIcon" icon="add-circle-outline"></core-icon>
			    	创建群笔记
			    </div>
			    <paper-ripple fit></paper-ripple>
		    </paper-shadow>
			<template repeat="{{group in groups}}">
			    <paper-shadow class="card" z="1" on-tap="{{selectGroup}}"
			    	hero-id="group-{{group.id}}" hero?="{{selectedGroup.id == group.id}}">
				    <div layout vertical cross-fade fit>
						<div class="title" horizontal layout center>
							{{group.name}}
						</div>
						<div class="content" flex>
							{{group.name}}
						</div>
				    </div>
				    <paper-ripple fit></paper-ripple>
			    </paper-shadow>
			</template>
		</div>

		<yo-groupdialog id="dialog" subject="创建新群组" on-action-confirm="{{createGroup}}"></yo-groupdialog>

	    <core-ajax id="request" url="{{request.url}}" method="{{request.method}}" handleAs="json" contentType="application/json"
		    body="{{request.body}}" on-core-response="{{handleResponse}}" on-core-error="{{handleError}}"></core-ajax>
	</template>
	<script>
	(function() {
		Polymer({
			selectGroup: function (event, detail, sender) {
				this.selectedGroup = event.target.templateInstance.model.group;
				this.fire('select-group', this.selectedGroup);
			},
			showGroupDialog: function (event, detail, sender) {
				this.$.dialog.showDialog();
			},
			cancelDialog: function (event, detail, sender) {
				this.$.dialog.closeDialog();
			},
			createGroup: function (event, detail, sender) {
				this.request = {
					url: '/note/api/group',
					method: 'POST',
					body: JSON.stringify({
						userid: this.userId,
						name: detail
					})
				};

				this.$.request.go();
			},
			handleResponse: function (event, detail, sender) {
				this.$.dialog.closeDialog();
				if (detail.response.success) {
					if (!this.groups) {
						this.groups = [];
					}
					this.groups.push(detail.response.data);
				} else {
					this.fire('user-error', detail.response.data);
				}
			},
			handleError: function (event, detail, sender) {
				this.$.dialog.closeDialog();
				this.fire('user-error', detail.toString());
			}
		});
	})();
	</script>
</polymer-element>